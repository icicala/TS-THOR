# THOR to Timesketch Mapper
This log conversion utility makes it easy to import [THOR](https://www.nextron-systems.com/thor/) logs into [Timesketch](https://timesketch.org/). Combining **THOR** findings on a shared timeline it enables cybersecurity analysts to enhance detection and analysis of malicious activity.
## Description
This utility processes **THOR** JSON logs and maps them to Timesketch’s required timeline format by:

* Extracting relevant fields from **THOR** logs

* Generating entries with the required Timesketch fields: message, datetime, and timestamp_desc

* Handling **THOR** events with multiple timestamps by duplicating the log entry for each timestamp found
## Field Mapping Logic
This utility maps the following fields from THOR logs to Timesketch's required format:

* **message**: A key detection detail generated by **THOR**, providing context or justification for the event.

* **datetime**:
  * The **THOR** scan execution time, or
  * A timestamp found within the specific event related to a module or feature.

* **timestamp_desc**:
  * If datetime refers to the THOR scan start time → "Timestamp of THOR scan execution"
  * If datetime originates from a specific module field → "ModuleName - FieldName" (e.g., Filescan - modified)

**Note**: **ruledate** field is not mapped to datetime.

This utility supports THOR JSON log format v2 and is designed with forward compatibility for JSON log format v3.
## Features

1. Validates and reads the input THOR JSON file
2. Flattening THOR logs for efficient indexing and searching
3. Identifies the THOR log version and selects the appropriate mapper
4. Extracts relevant information and timestamps from each log entry
5. Maps THOR fields to Timesketch's required format (message, datetime, timestamp_desc)
6. Writes the mapped events to a single JSONL output file
7. The resulting .jsonl file can be ingested into Timesketch using either the Web UI or the [Importer CLI tool](https://timesketch.org/guides/user/cli-client/)
8. Supports ingestion into Timesketch sketch by specifying the sketch ID or name

## Installation - MacOS/Linux
### Prerequisites
Ensure you have the following installed on your system:
* [Git](https://git-scm.com/downloads)
* [Python 3.9](https://www.python.org/downloads/) or higher
* Python venv package (on Ubuntu/Debian: `sudo apt install python3-venv`)
* [THOR](https://www.nextron-systems.com/thor/) JSON logs (v2 or v3) as input for thor2ts
### Steps
1. Clone the repository:
```bash
git clone https://github.com/TBD/thor-ts-mapper.git
cd thor-ts-mapper
```
2.1 Install thor2ts by sourcing the install script:
```bash
source install_thor2ts.sh
```
This script will:

* Check for prerequisites
* Create a virtual environment named venv-thor2ts
* Install thor2ts within the virtual environment
* Activate the virtual environment

2.2 Install thor2ts manually:
```bash
bash install_thor2ts.sh
```
Activate the virtual environment `venv-thor2ts`
4. Future Use
To use thor2ts in the new terminal, activate the virtual environment:
```bash
source /path/to/thor-ts-mapper/venv-thor2ts/bin/activate
```
Alternatively, you can source the install script again.
## Usage
Once the virtual environment is active, run the tool by specifying the path to the **THOR** JSON file along with one of output parameters.:

```bash
thor2ts <input_file> [-o <output_file>] [--ts_sketch <sketch_id_or_name>] [-v]
```
### Arguments
* `input_file` - Path to the THOR JSON file that you want to convert
#### Example
```bash
thor2ts thor_scan.json -o mapped_events.jsonl
```
* `-o output_file` - Output file path
#### Example
```bash
thor2ts thor_scan.json -o /path/to/output/thor2timesketch.jsonl
```
* `--ts_sketch <sketch_id_or_name>` - Send the mapped events to Timesketch by specifying the sketch ID or name.
Give the existing sketch name, otherwise the sketch will be created with the given name.
 
**First-time configuration**: When using this flag for the first time, you'll be prompted to configure Timesketch settings:
* `host_uri` - The URL of the Timesketch server.
* `auth_mode` - Authentication mode, valid choices are: "userpass" (user/pass) or "oauth"
* `username` - Your Timesketch username.
* `password` - Your Timesketch password. **Note:** The password will be tokenized.
This creates two configuration files in the user's home directory `$HOME/`:

`~/.timesketch.token` - Stores authentication tokens
`~/.timesketchrc` - Stores connection configuration with the following format:
```ini
[timesketch]
host_uri = http://timessketch.example.com
username = yourusername
verify = True
client_id = 
client_secret = 
auth_mode = userpass
cred_key = <generated_key>
```
#### Example
```bash
thor2ts thor_scan.json --ts_sketch "THOR APT Sketch"
```
or by using a valid sketch ID otherwise the sketch will be created with name `Sketch_<sketch_id>`:
```bash
thor2ts thor_scan.json --ts_sketch 1
```
* `-v, --verbose` - Enable verbose output (optional)
#### Example
```bash
thor2ts thor_scan.json -v
```
* `--version` - Show the version of the tool and exit (optional)
#### Example
```bash
thor2ts --version
```

## Input Files
**THOR** scan log file `.json` log version **v2** or **v3**

## Output Files
The tool writes converted events to a JSONL file. If the provided output file does not have a `.jsonl` extension, the file extension is updated to the JSONL format. If the file already exists, events are appended to it, otherwise, a new file is created. The tool also creates the output directory if it does not exist.
## Warning
The output file extension must end with `.jsonl` for successful ingestion into Timesketch. Files with other extensions (e.g `json`) may cause the import to fail.
## Ingesting into Timesketch
1. File `jsonl` - the resulting (`.jsonl`) file can be ingested into Timesketch using either the Web UI or the [Importer CLI tool](https://timesketch.org/guides/user/cli-client/).
2. Sketch - If you specify the `--ts_sketch` flag, the tool will automatically ingest the mapped events into the specified Timesketch sketch. The sketch will be created if it does not exist.
## Contributing
Contributions to `thor2ts` are welcome! If you'd like to contribute:
* Fork the repository.
* Create a feature branch.
* Submit a pull request with your improvements or bug fixes.

## Support
If you encounter any issues or have questions, please open an issue in the GitHub repository.